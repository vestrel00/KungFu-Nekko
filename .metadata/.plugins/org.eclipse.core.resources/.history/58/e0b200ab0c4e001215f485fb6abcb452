package com.vestrel00.nekko;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.audio.Music;
import com.badlogic.gdx.audio.Sound;
import com.badlogic.gdx.graphics.Color;
import com.badlogic.gdx.graphics.g2d.SpriteBatch;
import com.badlogic.gdx.graphics.g2d.TextureAtlas;
import com.badlogic.gdx.graphics.g2d.TextureAtlas.AtlasRegion;
import com.badlogic.gdx.graphics.glutils.ShapeRenderer;
import com.badlogic.gdx.graphics.glutils.ShapeRenderer.ShapeType;
import com.badlogic.gdx.math.Rectangle;
import com.badlogic.gdx.utils.Disposable;
import com.badlogic.gdx.utils.TimeUtils;
import com.vestrel00.nekko.extras.StringTyper;
import com.vestrel00.nekko.interf.Drawable;
import com.vestrel00.nekko.interf.Touchable;
import com.vestrel00.nekko.interf.Updatable;

public class IntroScreen implements Updatable, Drawable, Disposable, Touchable {

	public static final int VIEW_SPLASH_HOALW = 0, VIEW_SPLASH_DOGCHIKEN = 1,
			VIEW_SPLASH_BUCH = 2, VIEW_MENU = 3, VIEW_SELECTION = 4;

	private final CharSequence[] strings = { "HoaLW", "Productions", "Skip",
			"", "DogChiken", "Buch", "@OpenGameArt" };
	private float[] widths;

	// Sound in android may not be able to play onCreate or at least not right
	// after creation due to SoundPool implementation or LibGDX?
	private Music introsition, music, wrath;
	private Sound gruff;
	private TextureAtlas atlas;
	private AtlasRegion dogChikenRegion, buchRegion;
	private StringTyper typer;
	private Color color;
	private ShapeRenderer shape;
	private Rectangle splashRect, skipRect;
	private IntroMenuManager menu;
	private IntroSelectionManager selection;

	public int view;
	private int phase;
	private long phaseEndTime;

	public IntroScreen() {
		initResources();
		phase = 0;
		view = VIEW_SPLASH_HOALW;
		color = new Color(Color.CLEAR);
		widths = new float[strings.length];
		for (int i = 0; i < widths.length; i++)
			widths[i] = KFNekko.resource.chunkFive.getBounds(strings[i]).width;
		typer = new StringTyper(strings[0], 300000000L);
		shape = new ShapeRenderer();
		splashRect = new Rectangle();
		skipRect = new Rectangle(KFNekko.settings.viewWidthQuarter,
				KFNekko.settings.viewHeight * 0.75f, widths[2],
				KFNekko.resource.chunkFive.getBounds(strings[2]).height);
	}

	private void initResources() {
		atlas = new TextureAtlas(Gdx.files.internal("texture/intro.pack"));
		dogChikenRegion = atlas.findRegion("dogchiken");
		buchRegion = atlas.findRegion("buch");
		introsition = Gdx.audio.newMusic(Gdx.files
				.internal("sound/introsition.mp3"));
		music = Gdx.audio.newMusic(Gdx.files.internal("music/intro.mp3"));
		music.setLooping(true);
		gruff = Gdx.audio.newSound(Gdx.files.internal("sound/gruff.mp3"));
		wrath = Gdx.audio
				.newMusic(Gdx.files.internal("sound/wrathOfMagic.mp3"));
		if (KFNekko.settings.soundOn) {
			introsition.play();
			wrath.play();
		}
		menu = new IntroMenuManager(atlas);
		selection = new IntroSelectionManager(atlas);
	}

	@Override
	public void update() {
		switch (view) {
		case VIEW_SPLASH_HOALW:
			updateHoaLWSplash();
			break;
		case VIEW_SPLASH_DOGCHIKEN:
			updateDogChikenSplash();
			break;
		case VIEW_SPLASH_BUCH:
			updateBuchSplash();
			break;
		case VIEW_MENU:
			menu.update();
			break;
		case VIEW_SELECTION:
			selection.update();
			break;
		}
	}

	@Override
	public void draw(SpriteBatch batch) {
		switch (view) {
		case VIEW_SPLASH_HOALW:
			shape.begin(ShapeType.FilledRectangle);
			if (phase == 2)
				shape.setColor(color.a, color.a, color.a, color.a);
			else
				shape.setColor(Color.WHITE);
			shape.filledRect(splashRect.x, splashRect.y, splashRect.width,
					splashRect.height);
			shape.setColor(Color.BLACK);
			shape.filledRect(splashRect.x, 0.0f, KFNekko.settings.viewWidth,
					70.0f);
			shape.filledRect(splashRect.x, KFNekko.settings.viewHeight - 70.0f,
					KFNekko.settings.viewWidth, 70.0f);
			shape.end();

			batch.begin();
			KFNekko.resource.chunkFive.setColor(color);
			KFNekko.resource.chunkFive.draw(batch, typer.getTypedStr(),
					KFNekko.camera.camera.position.x - widths[0] * 0.5f,
					KFNekko.camera.camera.position.y + 30.0f);
			KFNekko.resource.chunkFive.draw(batch, strings[1],
					KFNekko.camera.camera.position.x - widths[1] * 0.5f,
					KFNekko.camera.camera.position.y - 5.0f);
			batch.end();
			break;
		case VIEW_SPLASH_DOGCHIKEN:
			batch.begin();
			batch.setColor(color);
			batch.draw(dogChikenRegion, 0.0f, 0.0f);
			KFNekko.resource.chunkFive.setColor(0.98f, 0.31f, 0.262f, color.a);
			KFNekko.resource.chunkFive.draw(batch, typer.getTypedStr(), 20.0f,
					KFNekko.camera.camera.position.y + 15.0f);
			KFNekko.resource.chunkFive.draw(batch, strings[6],
					KFNekko.camera.camera.position.x - widths[6] * 0.5f, 60.0f);
			batch.end();
			break;
		case VIEW_SPLASH_BUCH:
			batch.begin();
			batch.setColor(color);
			batch.draw(buchRegion, 0.0f, 0.0f);
			KFNekko.resource.chunkFive.setColor(0.5764f, 0.2549f, 0.0235f,
					color.a);
			KFNekko.resource.chunkFive.draw(batch, typer.getTypedStr(),
					KFNekko.camera.camera.position.x + 120.0f,
					KFNekko.camera.camera.position.y + 130.0f);
			KFNekko.resource.chunkFive.draw(batch, strings[6],
					KFNekko.camera.camera.position.x - widths[6] * 0.5f, 60.0f);
			batch.end();
			break;
		case VIEW_MENU:
			menu.draw(batch);
			break;
		case VIEW_SELECTION:
			selection.draw(batch);
			break;
		}
	}

	@Override
	public boolean onTouchDown(float x, float y) {
		switch (view) {
		case VIEW_SPLASH_HOALW:
		case VIEW_SPLASH_DOGCHIKEN:
		case VIEW_SPLASH_BUCH:
			if (skipRect.contains(x, y))
				view = VIEW_MENU;
			break;
		case VIEW_MENU:
			menu.onTouchDown(x, y);
			break;
		case VIEW_SELECTION:
			selection.onTouchDown(x, y);
			break;
		}
		return false;
	}

	@Override
	public void dispose() {
		atlas.dispose();
		introsition.dispose();
		shape.dispose();
		music.dispose();
		gruff.dispose();
	}

	private boolean updateColor(float colorSpeed) {
		switch (phase) {
		case 0:
			color.r += colorSpeed;
			color.g += colorSpeed;
			color.b += colorSpeed;
			color.a += colorSpeed;
			if (color.a > 1.0f) {
				phaseEndTime = TimeUtils.nanoTime();
				phase = 1;
				color.r = 1.0f;
				color.g = 1.0f;
				color.b = 1.0f;
				color.a = 1.0f;
				return true;
			}
			break;
		case 1:
			if (TimeUtils.nanoTime() - phaseEndTime > 2000000000L) {
				phaseEndTime = TimeUtils.nanoTime();
				phase = 2;
				return true;
			}
			break;
		case 2:
			color.a -= 0.03f;
			if (color.a < 0.0f) {
				color.set(Color.CLEAR);
				return true;
			}
			break;
		}
		return false;
	}

	private void updateBuchSplash() {
		switch (phase) {
		case 0:
			typer.update();
			if (updateColor(0.04f))
				gruff.play(1.0f, 1.0f, Audio
						.getSoundPan(KFNekko.camera.camera.position.x - 40.0f));
			break;
		case 1:
			typer.update();
			if (updateColor(0.04f))
				// make sure typer is finished
				typer.finish();
			break;
		case 2:
			if (updateColor(0.04f)) {
				phase = 0;
				view = VIEW_MENU;
				if (KFNekko.settings.musicOn)
					music.play();
			}
		}
	}

	private void updateDogChikenSplash() {
		switch (phase) {
		case 0:
			typer.update();
			if (updateColor(0.04f)) {
				KFNekko.audio.meow(KFNekko.camera.camera.position.x + 40.0f);
			}
			break;
		case 1:
			typer.update();
			if (updateColor(0.04f))
				// make sure typer is finished
				typer.finish();

			break;
		case 2:
			if (updateColor(0.04f)) {
				phase = 0;
				typer.reset(strings[5], 300000000L);
				view = VIEW_SPLASH_BUCH;
			}
		}
	}

	private void updateHoaLWSplash() {
		switch (phase) {
		case 0:
			splashRect
					.set(KFNekko.camera.rect.x,
							KFNekko.camera.camera.position.y
									- splashRect.height * 0.5f,
							splashRect.width + 10.0f, 2.0f);
			typer.update();
			if (updateColor(0.02f)) {
				// make sure typer is finished
				typer.finish();
				// make sure width is full
				splashRect.width = KFNekko.settings.viewWidth;
			}
			break;
		case 1:
			if ((color.r -= 0.02f) < 0.0f)
				color.r = 0.0f;
			if ((color.g -= 0.02f) < 0.0f)
				color.g = 0.0f;
			if ((color.b -= 0.02f) < 0.0f)
				color.b = 0.0f;
			splashRect.height += 4.0f;
			splashRect.y = KFNekko.camera.camera.position.y - splashRect.height
					* 0.5f;
			updateColor(0.02f);
			break;
		case 2:
			if (updateColor(0.02f)) {
				phase = 0;
				typer.reset(strings[4], 100000000L);
				view = VIEW_SPLASH_DOGCHIKEN;
			}
		}
	}

}
