package com.vestrel00.nekko.actors.components;

import com.badlogic.gdx.graphics.Color;
import com.badlogic.gdx.graphics.g2d.SpriteBatch;
import com.badlogic.gdx.graphics.g2d.TextureAtlas;
import com.badlogic.gdx.graphics.g2d.TextureAtlas.AtlasRegion;
import com.badlogic.gdx.utils.TimeUtils;
import com.vestrel00.nekko.Camera;
import com.vestrel00.nekko.KFNekko;
import com.vestrel00.nekko.actors.Nekko;
import com.vestrel00.nekko.actors.components.effects.AfterImage;
import com.vestrel00.nekko.actors.states.CombatState;
import com.vestrel00.nekko.actors.states.FaceState;

public class NekkoSprite extends Sprite {

	// animation frames
	private AtlasRegion[] idle, walk, jump, doubleJump, spinKick, powerShot,
			fastShot, flyingKick, superUppercut, oneTwoCombo, lowMiddleKick,
			highKick, downwardKick, twoSidedAttack, roundKick, uppercut;

	public int idleIndex = 0, walkIndex = 0, jumpIndex = 0,
			doubleJumpIndex = 0;

	// afterImages
	private AfterImage[] combatImages, effectImages;
	private int combatImgIndex = 0, effectImgIndex = 0;
	private AtlasRegion attackEffect1, smokeEffect;

	private Nekko nekko;
	public long speedUp, lastCombatImage;
	public int damageMultiplier;

	public NekkoSprite(Nekko nekko, TextureAtlas atlas, Color color) {
		super(nekko, color);
		this.nekko = nekko;
		initTextures(atlas);
		initEffects(atlas);
		speedUp = 0L;
		damageMultiplier = 1;
	}

	private void initEffects(TextureAtlas atlas) {
		combatImages = new AfterImage[6];
		effectImages = new AfterImage[10];
		for (int i = 0; i < combatImages.length; i++)
			combatImages[i] = new AfterImage();
		for (int i = 0; i < effectImages.length; i++)
			effectImages[i] = new AfterImage();
		attackEffect1 = atlas.findRegion("attackEffect1");
		smokeEffect = atlas.findRegion("smokeEffect");
	}

	private void initTextures(TextureAtlas atlas) {
		idle = new AtlasRegion[4];
		doubleJump = new AtlasRegion[4];
		highKick = new AtlasRegion[6];
		fastShot = new AtlasRegion[6];
		powerShot = new AtlasRegion[7];
		uppercut = new AtlasRegion[7]; // added 1 frame
		flyingKick = new AtlasRegion[8];
		walk = new AtlasRegion[8];
		jump = new AtlasRegion[8];
		downwardKick = new AtlasRegion[9]; // added 1 frame
		twoSidedAttack = new AtlasRegion[9]; // added 1 frame
		roundKick = new AtlasRegion[9]; // added 1 frame
		spinKick = new AtlasRegion[10];
		oneTwoCombo = new AtlasRegion[10];
		lowMiddleKick = new AtlasRegion[12];
		superUppercut = new AtlasRegion[13];

		int i = 0;
		for (i = 0; i < 4; i++) {
			idle[i] = atlas.findRegion("nekkoIdle" + String.valueOf(i));
			doubleJump[i] = atlas.findRegion("nekkoDoubleJump"
					+ String.valueOf(i));
		}
		for (i = 0; i < 6; i++) {
			highKick[i] = atlas.findRegion("nekkoHighKick" + String.valueOf(i));
			fastShot[i] = atlas.findRegion("nekkoFastShot" + String.valueOf(i));
		}
		for (i = 0; i < 7; i++) {
			powerShot[i] = atlas.findRegion("nekkoPowerShot"
					+ String.valueOf(i));
			uppercut[i] = atlas.findRegion("nekkoUppercut" + String.valueOf(i));
		}
		for (i = 0; i < 8; i++) {
			flyingKick[i] = atlas.findRegion("nekkoFlyingKick"
					+ String.valueOf(i));
			walk[i] = atlas.findRegion("nekkoWalk" + String.valueOf(i));
			jump[i] = atlas.findRegion("nekkoJump" + String.valueOf(i));
		}
		for (i = 0; i < 9; i++) {
			downwardKick[i] = atlas.findRegion("nekkoDownwardKick"
					+ String.valueOf(i));
			twoSidedAttack[i] = atlas.findRegion("nekkoTwoSidedAttack"
					+ String.valueOf(i));
			roundKick[i] = atlas.findRegion("nekkoRoundKick"
					+ String.valueOf(i));
		}
		for (i = 0; i < 10; i++) {
			spinKick[i] = atlas.findRegion("nekkoSpin" + String.valueOf(i));
			oneTwoCombo[i] = atlas.findRegion("nekkoOneTwoCombo"
					+ String.valueOf(i));
		}
		for (i = 0; i < 12; i++)
			lowMiddleKick[i] = atlas.findRegion("nekkoLowMiddleKick"
					+ String.valueOf(i));
		for (i = 0; i < 13; i++)
			superUppercut[i] = atlas.findRegion("nekkoSuperUppercut"
					+ String.valueOf(i));

		currentTexture = idle[0];
	}

	@Override
	public void update() {
		// update after images
		for (int i = 0; i < combatImages.length; i++)
			combatImages[i].update();
		// update after images
		for (int i = 0; i < effectImages.length; i++)
			effectImages[i].update();

		if (TimeUtils.nanoTime() - lastAnimationTime < animationDelay)
			return;
		lastAnimationTime = TimeUtils.nanoTime();

		xScale = (nekko.faceState == FaceState.LEFT) ? -1.0f : 1.0f;

		switchCombatImages();

		// animate
		if (switchCombatState())
			return;
		if (switchVerticalMotionState())
			return;

		switchHorizontalMotionState();
	}

	private int incrementIndex(int index, int maxIndex) {
		if (++index == maxIndex)
			return 0;
		else
			return index;
	}

	private void activateEffect() {
		KFNekko.bumpWC(0.1f, 0.1f, 0.1f);
		float zoomAmount = 0.0f;
		// step forward
		if (!nekko.location.onSlope
				&& actor.location.rect.x >= 12.0f
				&& actor.location.rect.x + actor.location.rect.width <= KFNekko.map.width - 12.0f)
			actor.location.x += (nekko.faceState == FaceState.LEFT) ? -12.0f
					: 12.0f;
		switch (nekko.combatState) {
		case SPIN:
			zoomAmount = 0.07f;
			break;
		case FASTSHOT:
		case ONETWOCOMBO:
			effectImgIndex = incrementIndex(effectImgIndex, effectImages.length);
			if (nekko.faceState == FaceState.LEFT)
				effectImages[effectImgIndex].activate(attackEffect1,
						nekko.location.rect.x + 10.0f, nekko.location.y - 3.0f,
						0.08f, -0.3f, false, 0.0f, color);
			else
				effectImages[effectImgIndex].activate(attackEffect1,
						nekko.location.rect.x + nekko.location.rect.width
								- 10.0f, nekko.location.y - 3.0f, 0.08f, 0.3f,
						true, 0.0f);
			zoomAmount = 0.035f;
			break;
		case POWERSHOT:
			zoomAmount = 0.07f;
			break;
		case FLYINGKICK:
			zoomAmount = 0.05f;
			break;
		case SUPERUPPERCUT:
			zoomAmount = 0.09f;
			break;
		case LOWMIDDLEKICK:
			zoomAmount = 0.035f;
			break;
		case HIGHKICK:
			zoomAmount = 0.035f;
			break;
		case DOWNWARDKICK:
			zoomAmount = 0.05f;
			break;
		case TWOSIDEDATTACK:
			effectImgIndex = incrementIndex(effectImgIndex, effectImages.length);
			effectImages[effectImgIndex].activate(currentTexture,
					nekko.location.x, nekko.location.y, 0.08f, -12.0f, true,
					2.0f);
			effectImgIndex = incrementIndex(effectImgIndex, effectImages.length);
			effectImages[effectImgIndex].activate(currentTexture,
					nekko.location.x, nekko.location.y, 0.08f, 12.0f, false,
					2.0f);
			zoomAmount = 0.08f;
			break;
		case ROUNDKICK:
			zoomAmount = 0.06f;
			break;
		case UPPERCUT:
			zoomAmount = 0.065f;
			break;
		}
		KFNekko.camera.setEffect(Camera.EFFECT_ZOOM, zoomAmount, 0.0063f, 0L);
	}

	private void switchCombatImages() {
		if (nekko.combatState != CombatState.IDLE
				&& TimeUtils.nanoTime() - lastCombatImage > 60000000L) {
			lastCombatImage = TimeUtils.nanoTime();
			combatImgIndex = incrementIndex(combatImgIndex, combatImages.length);
			combatImages[combatImgIndex].activate(currentTexture,
					nekko.location.x, nekko.location.y, 0.04f, 0.0f,
					(nekko.faceState == FaceState.LEFT) ? true : false, 0.0f);
		}
		switch (nekko.combatState) {
		case SPIN:
			break;
		case SUPERUPPERCUT:
			break;
		case FLYINGKICK:
			break;
		case ONETWOCOMBO:
			break;
		case FASTSHOT:

			break;
		case POWERSHOT:

			break;
		case LOWMIDDLEKICK:

			break;
		case HIGHKICK:

			break;
		case DOWNWARDKICK:

			break;
		case TWOSIDEDATTACK:

			break;
		case ROUNDKICK:

			break;
		case UPPERCUT:

			break;
		}
	}

	@Override
	public void draw(SpriteBatch batch) {
		// draw after images
		for (int i = 0; i < combatImages.length; i++)
			combatImages[i].draw(batch);
		super.draw(batch);
		// draw after images
		for (int i = 0; i < effectImages.length; i++)
			effectImages[i].draw(batch);
		batch.setColor(KFNekko.worldColor);
	}

	private boolean switchHorizontalMotionState() {
		if (nekko.location.onPlatform || nekko.location.onSlope)
			switch (nekko.horizontalMotionState) {
			case IDLE:
				if (++idleIndex == idle.length)
					idleIndex = 0;
				currentTexture = idle[idleIndex];
				animationDelay = 120000000L;
				return true;
			case MOVING:
				if (++walkIndex == walk.length)
					walkIndex = 0;
				currentTexture = walk[walkIndex];
				if (nekko.location.onSlope)
					animationDelay = 40000000L;
				else
					animationDelay = 20000000L;
				return true;
			default:
				return false;
			}
		else
			return false;
	}

	private boolean switchVerticalMotionState() {
		if (nekko.location.doubleJumped) {
			if (++doubleJumpIndex >= doubleJump.length)
				doubleJumpIndex = 0;
			currentTexture = doubleJump[doubleJumpIndex];
			animationDelay = 50000000L;
			return true;
		}

		switch (nekko.verticalMotionState) {
		case JUMPING:
			if (++jumpIndex >= jump.length)
				return false;
			currentTexture = jump[jumpIndex];
			animationDelay = 60000000L;
			return true;
		default:
			return false;
		}
	}

	private boolean switchCombatState() {
		switch (nekko.combatState) {
		case SPIN:
			if (++combatIndex == spinKick.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 7) {
				nekko.attack(2 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = spinKick[combatIndex];
			animationDelay = 40000000L;
			return true;
		case FASTSHOT:
			if (++combatIndex == fastShot.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 4) {
				nekko.attack(1 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = fastShot[combatIndex];
			animationDelay = 30000000 - speedUp;
			return true;
		case POWERSHOT:
			if (++combatIndex == powerShot.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 5) {
				// nekko.attack(3 * damageMultiplier, false);
				// TODO launch projectile
				activateEffect();
			}
			currentTexture = powerShot[combatIndex];
			animationDelay = 60000000 - speedUp;
			return true;
		case FLYINGKICK:
			if (++combatIndex == flyingKick.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 5) {
				nekko.attack(1 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = flyingKick[combatIndex];
			animationDelay = 30000000 - speedUp;
			return true;
		case SUPERUPPERCUT:
			if (++combatIndex == superUppercut.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 5) {
				nekko.attack(3 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = superUppercut[combatIndex];
			animationDelay = 20000000 - speedUp;
			return true;
		case ONETWOCOMBO:
			if (++combatIndex == oneTwoCombo.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 4 || combatIndex == 7) {
				nekko.attack(1 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = oneTwoCombo[combatIndex];
			animationDelay = 40000000 - speedUp;
			return true;
		case LOWMIDDLEKICK:
			if (++combatIndex == lowMiddleKick.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 2 || combatIndex == 8) {
				nekko.attack(1 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = lowMiddleKick[combatIndex];
			animationDelay = 45000000 - speedUp;
			return true;
		case HIGHKICK:
			if (++combatIndex == highKick.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 2) {
				nekko.attack(2 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = highKick[combatIndex];
			animationDelay = 60000000 - speedUp;
			return true;
		case DOWNWARDKICK:
			if (++combatIndex == downwardKick.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 7) {
				nekko.attack(2 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = downwardKick[combatIndex];
			animationDelay = 50000000 - speedUp;
			return true;
		case TWOSIDEDATTACK:
			if (++combatIndex == twoSidedAttack.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 6) {
				nekko.attack(1 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = twoSidedAttack[combatIndex];
			animationDelay = 50000000 - speedUp;
			return true;
		case ROUNDKICK:
			if (++combatIndex == roundKick.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 5) {
				nekko.attack(2 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = roundKick[combatIndex];
			animationDelay = 50000000 - speedUp;
			return true;
		case UPPERCUT:
			if (++combatIndex == uppercut.length) {
				combatIndex = 0;
				nekko.onDeactivateCombat();
			}
			if (combatIndex == 4) {
				nekko.attack(2 * damageMultiplier, true);
				activateEffect();
			}
			currentTexture = uppercut[combatIndex];
			animationDelay = 70000000 - speedUp;
			return true;
		default:
			return false;
		}
	}

	public void activateSmoke() {
		effectImgIndex = incrementIndex(effectImgIndex, effectImages.length);
		effectImages[effectImgIndex].activate(smokeEffect, nekko.location.x,
				nekko.location.rect.y, 0.08f, -12.0f, true, 2.0f);
		effectImgIndex = incrementIndex(effectImgIndex, effectImages.length);
		effectImages[effectImgIndex].activate(smokeEffect, nekko.location.x,
				nekko.location.rect.y, 0.08f, 12.0f, false, 2.0f);
	}

}
